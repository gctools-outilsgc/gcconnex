trigger:  # don't trigger outside PRs
- none

pr:  # Trigger the pipeline only for PRs targeting master branch
- master


variables:
  imageRepository: 'collab'

pool:
  vmImage: 'ubuntu-latest'


steps:
- task: Docker@2
  displayName: Build and Push Container image to ACR
  inputs:
    command: 'buildAndPush'
    containerRegistry: $(acrName)
    repository: '$(imageRepository)_pr_$(System.PullRequest.PullRequestNumber)'
    tags: '$(Build.SourceVersion)'
  env:
    acrName: $(acrName)

- bash: |
    curl -L \
      -X POST \
      -H "Accept: application/vnd.github+json" \
      -H "Authorization: Bearer $SYSTEM_ACCESSTOKEN"\
      -H "X-GitHub-Api-Version: 2022-11-28" \
      -d '{"body": "Test comment from Azure Pipelines"}' \
      "https://api.github.com/repos/gctools-outilsgc/gcconnex/issues/$PR_NUMBER/comments"
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
    PR_NUMBER: $(System.PullRequest.PullRequestNumber)
  condition: succeeded()
  displayName: 'Post a comment to PR'
