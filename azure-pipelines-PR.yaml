trigger:  # don't trigger outside PRs
- none

pr:  # Trigger the pipeline only for PRs targeting master branch
- master


variables:
  imageRepository: 'collab'

pool:
  vmImage: 'ubuntu-latest'


steps:
- task: Docker@2
  displayName: Build and Push Container image to ACR
  inputs:
    command: 'buildAndPush'
    containerRegistry: $(acrName)
    repository: '$(imageRepository)_pr_$(System.PullRequest.PullRequestNumber)'
    tags: '$(Build.SourceVersion)'
  env:
    acrName: $(acrName)

- script: |
    curl -H "Authorization: token $(SYSTEM_ACCESSTOKEN)" \
         -X POST \
         -d '{"body": "Test comment from Azure Pipelines"}' \
         "https://api.github.com/repos/gctools-outilsgc/gcconnex/issues/$(PR_ID)/comments"
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
    PR_ID: $(System.PullRequest.PullRequestId)
  displayName: 'Post a comment to PR'
