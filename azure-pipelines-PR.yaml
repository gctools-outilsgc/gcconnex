trigger:  # don't trigger outside PRs
- none

pr:  # Trigger the pipeline only for PRs targeting master branch
- master


variables:
  imageRepository: 'collab'
  location: 'canadacentral'
  RGtemplateFile: '.bicep/PR/test-instance-setup.bicep'

pool:
  vmImage: 'ubuntu-latest'


steps:
- task: Docker@2
  displayName: Build and Push Container image to ACR
  inputs:
    command: 'buildAndPush'
    containerRegistry: $(acrName)
    repository: '$(imageRepository)_pr_$(System.PullRequest.PullRequestNumber)'
    tags: '$(Build.SourceVersion)'
  env:
    acrName: $(acrName)

- task: AzureCLI@2
  displayName: set up review / test instance
  condition: succeeded()
  inputs:
    azureSubscription: 'gccollab_review'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az deployment sub create --location $(location) --template-file $(RGtemplateFile) \
        --parameters prNumber=$PR dbServerName=$DBSERVERNAME dbServerRG=$DBRG containerTag=$TAG dbServerPass=DB_SERVER_PASS \
        subnetID=$SUBNET_ID planID=$PLAN_ID
  env:
    DBRG: "DEV"
    DBSERVERNAME: ${review_db_server_name}
	DB_SERVER_PASS: ${review_db_server_pass}
    TAG: $(Build.SourceVersion)
    PR: $(System.PullRequest.PullRequestNumber)
    SUBNET_ID: ${review_subnet_ID}
    PLAN_ID: ${review_plan_ID}

- bash: |
    curl -L \
      -X POST \
      -H "Accept: application/vnd.github+json" \
      -H "Authorization: Bearer $SYSTEM_ACCESSTOKEN"\
      -H "X-GitHub-Api-Version: 2022-11-28" \
      -d '{"body": "The review site is up at https://gccollab-dev-PR_$PR_NUMBER.azurewebsites.net"}' \
      "https://api.github.com/repos/gctools-outilsgc/gcconnex/issues/$PR_NUMBER/comments"
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
    PR_NUMBER: $(System.PullRequest.PullRequestNumber)
  condition: succeeded()
  displayName: 'Post a comment to PR'
